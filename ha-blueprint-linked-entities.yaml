blueprint:
  name: Sync Lights (Strict On/Off/Brightness)
  description: >
    A streamlined blueprint to sync states and brightness of multiple lights. 
    Prevents infinite loops and the "100% brightness jump" common with smart dimmers.
  domain: automation
  input:
    target_lights:
      name: Linked Lights
      description: Select the lights you want to synchronize.
      selector:
        entity:
          domain: light
          multiple: true

# 'restart' is crucial for Lutron/dimmers. If it sends "on" and then "brightness: 25" 
# a few milliseconds later, this ensures the second, more accurate event is processed immediately.
mode: restart
max_exceeded: silent

variables:
  linked_lights: !input target_lights

trigger:
  # A unified state trigger catches everything. We filter the noise in the conditions/actions.
  - platform: state
    entity_id: !input target_lights

condition:
  # Loop Prevention: Stop if the trigger was generated by this automation's own action
  - condition: template
    value_template: "{{ trigger.to_state.context.id != this.context.id }}"
  # Ignore intermediary states like 'unavailable' or 'unknown'
  - condition: template
    value_template: "{{ trigger.to_state.state in ['on', 'off'] }}"

action:
  - variables:
      # Bulletproof Reject Logic: expand() normalizes the input into standard state objects,
      # map() extracts just the string IDs, and then we reject the trigger ID.
      target_entities: >
        {{ expand(linked_lights) | map(attribute='entity_id') | reject('eq', trigger.entity_id) | list }}

  - choose:
      # SCENARIO 1: Light turned OFF
      - conditions:
          - condition: template
            value_template: "{{ trigger.to_state.state == 'off' }}"
        sequence:
          - service: light.turn_off
            target:
              entity_id: "{{ target_entities }}"

      # SCENARIO 2: Light turned ON or Brightness Adjusted
      - conditions:
          - condition: template
            value_template: "{{ trigger.to_state.state == 'on' }}"
        sequence:
          - service: light.turn_on
            target:
              entity_id: "{{ target_entities }}"
            # Dynamic Data Injection: This is the fix for the 100% jump.
            # If the trigger contains brightness, we pass it. If it doesn't, we pass an 
            # empty dictionary {}, which tells HA "just turn on to your previous memory state".
            data: >
              {% set b = state_attr(trigger.entity_id, 'brightness') %}
              {% if b != none %}
                {"brightness": {{ b }}}
              {% else %}
                {}
              {% endif %}
